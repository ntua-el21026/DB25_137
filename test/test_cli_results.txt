DEBUG: Entered test_cli.sh
DB137=python3 test/../cli/db137.py
/usr/bin/bash

========== USER COMMANDS TEST ==========
Working dir: /mnt/c/Projects/DB25_137
Database: pulse_university
Output: test/test_cli_results.txt
========================================

▶ Drop pulse_university DB...
Command: python3 test/../cli/db137.py drop-db --database pulse_university --yes
[OK] Schema `pulse_university` dropped
[PASS] Drop pulse_university DB

▶ Create pulse_university DB...
Command: python3 test/../cli/db137.py create-db
[OK] install.sql
[OK] indexing.sql
[OK] procedures.sql
[OK] triggers.sql
[OK] views.sql
[OK] Database schema deployed
[PASS] Create pulse_university DB

▶ Drop user testuser1 (if exists)...
Command: python3 test/../cli/db137.py users drop testuser1
Dropped user testuser1.
[PASS] Drop user testuser1 (if exists)

▶ Drop user testuser2 (if exists)...
Command: python3 test/../cli/db137.py users drop testuser2
[WARN] User `testuser2` not found on '%' or 'localhost'.
Dropped user testuser2.
[PASS] Drop user testuser2 (if exists)

▶ Drop user testuser3 (if exists)...
Command: python3 test/../cli/db137.py users drop testuser3
[WARN] User `testuser3` not found on '%' or 'localhost'.
Dropped user testuser3.
[PASS] Drop user testuser3 (if exists)

▶ Register testuser1 with basic privileges...
Command: python3 test/../cli/db137.py users register testuser1 --password Test1234! --default-db pulse_university --privileges SELECT,INSERT,UPDATE,DELETE
[OK] Registered `testuser1` with privileges on `pulse_university` for % and localhost
User 'testuser1' registered. Use `db137 users list` to verify grants.
[PASS] Register testuser1 with basic privileges

▶ Current grants for testuser1:
- testuser1
  GRANT USAGE ON *.* TO `testuser1`@`%`
  GRANT SELECT, INSERT, UPDATE, DELETE ON `pulse_university`.* TO `testuser1`@`%`

▶ Register testuser2 with default privileges...
Command: python3 test/../cli/db137.py users register testuser2 --password Test1234! --default-db pulse_university
[OK] Registered `testuser2` with privileges on `pulse_university` for % and localhost
User 'testuser2' registered. Use `db137 users list` to verify grants.
[PASS] Register testuser2 with default privileges

▶ Current grants for testuser2:
- testuser2
  GRANT USAGE ON *.* TO `testuser2`@`%`
  GRANT ALL PRIVILEGES ON `pulse_university`.* TO `testuser2`@`%`

▶ List all users...
Command: python3 test/../cli/db137.py users list
- root
  GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `root`@`%` WITH GRANT OPTION
  GRANT APPLICATION_PASSWORD_ADMIN,AUDIT_ABORT_EXEMPT,AUDIT_ADMIN,AUTHENTICATION_POLICY_ADMIN,BACKUP_ADMIN,BINLOG_ADMIN,BINLOG_ENCRYPTION_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,FIREWALL_EXEMPT,FLUSH_OPTIMIZER_COSTS,FLUSH_STATUS,FLUSH_TABLES,FLUSH_USER_RESOURCES,GROUP_REPLICATION_ADMIN,GROUP_REPLICATION_STREAM,INNODB_REDO_LOG_ARCHIVE,INNODB_REDO_LOG_ENABLE,PASSWORDLESS_USER_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_APPLIER,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SENSITIVE_VARIABLES_OBSERVER,SERVICE_CONNECTION_ADMIN,SESSION_VARIABLES_ADMIN,SET_USER_ID,SHOW_ROUTINE,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN,TABLE_ENCRYPTION_ADMIN,TELEMETRY_LOG_ADMIN,XA_RECOVER_ADMIN ON *.* TO `root`@`%` WITH GRANT OPTION
- testuser1
  GRANT USAGE ON *.* TO `testuser1`@`%`
  GRANT SELECT, INSERT, UPDATE, DELETE ON `pulse_university`.* TO `testuser1`@`%`
- testuser2
  GRANT USAGE ON *.* TO `testuser2`@`%`
  GRANT ALL PRIVILEGES ON `pulse_university`.* TO `testuser2`@`%`
[PASS] List all users

▶ Revoke INSERT from testuser1 with --show-diff...
Command: python3 test/../cli/db137.py users revoke testuser1 --db pulse_university --privileges INSERT --show-diff
Before:
  testuser1@% →
  - DELETE
  - INSERT
  - SELECT
  - UPDATE
[OK] Re-granted: DELETE,SELECT,UPDATE
Revoked INSERT on pulse_university from testuser1.
After:
  testuser1@% →
  - DELETE
  - SELECT
  - UPDATE
[PASS] Revoke INSERT from testuser1 with --show-diff

▶ Current grants for testuser1:
- testuser1
  GRANT USAGE ON *.* TO `testuser1`@`%`
  GRANT SELECT, UPDATE, DELETE ON `pulse_university`.* TO `testuser1`@`%`

▶ Change password for testuser1...
Command: python3 test/../cli/db137.py users passwd testuser1 --new-pass NewTest5678!
Password updated.
[PASS] Change password for testuser1

▶ Verify login as testuser1 after password change...
Command: env DB_ROOT_USER=testuser1 DB_ROOT_PASS=NewTest5678! python3 test/../cli/db137.py users whoami
Connected as: testuser1@localhost
[PASS] Verify login as testuser1 after password change

▶ Rename testuser1 to testuser3...
Command: python3 test/../cli/db137.py users rename testuser1 testuser3
testuser1 renamed to testuser3.
[PASS] Rename testuser1 to testuser3

▶ Current grants for testuser3:
- testuser3
  GRANT USAGE ON *.* TO `testuser3`@`%`
  GRANT SELECT, UPDATE, DELETE ON `pulse_university`.* TO `testuser3`@`%`

▶ Set default privileges for testuser3 with --show-diff...
Command: python3 test/../cli/db137.py users set-defaults testuser3 --show-diff
Before:
  testuser3@% →
  - DELETE
  - SELECT
  - UPDATE
After:
  testuser3@% →
  - DELETE
  - INSERT
  - SELECT
  - UPDATE
Granted default perms to testuser3 on pulse_university
[PASS] Set default privileges for testuser3 with --show-diff

▶ Current grants for testuser3:
- testuser3
  GRANT USAGE ON *.* TO `testuser3`@`%`
  GRANT SELECT, INSERT, UPDATE, DELETE ON `pulse_university`.* TO `testuser3`@`%`

▶ Grant INSERT to testuser3 with --show-diff...
Command: python3 test/../cli/db137.py users grant testuser3 --db pulse_university --privileges INSERT --show-diff
Before:
  testuser3@% →
  - DELETE
  - INSERT
  - SELECT
  - UPDATE
Granted INSERT on pulse_university to testuser3.
After:
  testuser3@% →
  - DELETE
  - INSERT
  - SELECT
  - UPDATE
[PASS] Grant INSERT to testuser3 with --show-diff

▶ Current grants for testuser3:
- testuser3
  GRANT USAGE ON *.* TO `testuser3`@`%`
  GRANT SELECT, INSERT, UPDATE, DELETE ON `pulse_university`.* TO `testuser3`@`%`

▶ List all users after rename...
Command: python3 test/../cli/db137.py users list
- root
  GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `root`@`%` WITH GRANT OPTION
  GRANT APPLICATION_PASSWORD_ADMIN,AUDIT_ABORT_EXEMPT,AUDIT_ADMIN,AUTHENTICATION_POLICY_ADMIN,BACKUP_ADMIN,BINLOG_ADMIN,BINLOG_ENCRYPTION_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,FIREWALL_EXEMPT,FLUSH_OPTIMIZER_COSTS,FLUSH_STATUS,FLUSH_TABLES,FLUSH_USER_RESOURCES,GROUP_REPLICATION_ADMIN,GROUP_REPLICATION_STREAM,INNODB_REDO_LOG_ARCHIVE,INNODB_REDO_LOG_ENABLE,PASSWORDLESS_USER_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_APPLIER,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SENSITIVE_VARIABLES_OBSERVER,SERVICE_CONNECTION_ADMIN,SESSION_VARIABLES_ADMIN,SET_USER_ID,SHOW_ROUTINE,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN,TABLE_ENCRYPTION_ADMIN,TELEMETRY_LOG_ADMIN,XA_RECOVER_ADMIN ON *.* TO `root`@`%` WITH GRANT OPTION
- testuser2
  GRANT USAGE ON *.* TO `testuser2`@`%`
  GRANT ALL PRIVILEGES ON `pulse_university`.* TO `testuser2`@`%`
- testuser3
  GRANT USAGE ON *.* TO `testuser3`@`%`
  GRANT SELECT, INSERT, UPDATE, DELETE ON `pulse_university`.* TO `testuser3`@`%`
[PASS] List all users after rename

▶ Show whoami as testuser3...
Command: env DB_ROOT_USER=testuser3 DB_ROOT_PASS=NewTest5678! python3 test/../cli/db137.py users whoami
Connected as: testuser3@%
[PASS] Show whoami as testuser3

========== ACCESS CONTROL TESTS ==========

▶ Reject register attempt as testuser2...
Command: env DB_ROOT_USER=testuser2 DB_ROOT_PASS=Test1234! python3 test/../cli/db137.py users register shouldfail --password dummy --default-db pulse_university --privileges SELECT
Error: This command is restricted to root users.
[PASS] Reject register attempt as testuser2 (expected failure)
Exit code: 0

▶ Reject drop attempt as testuser2...
Command: env DB_ROOT_USER=testuser2 DB_ROOT_PASS=Test1234! python3 test/../cli/db137.py users drop testuser3
Error: This command is restricted to root users.
[PASS] Reject drop attempt as testuser2 (expected failure)
Exit code: 0

▶ Reject rename attempt as testuser2 (on another user)...
Command: env DB_ROOT_USER=testuser2 DB_ROOT_PASS=Test1234! python3 test/../cli/db137.py users rename testuser3 eviluser
Error: You can only modify your own account.
[PASS] Reject rename attempt as testuser2 (on another user) (expected failure)
Exit code: 0

▶ Reject set-defaults attempt as testuser2...
Command: env DB_ROOT_USER=testuser2 DB_ROOT_PASS=Test1234! python3 test/../cli/db137.py users set-defaults testuser1
Error: This command is restricted to root users.
[PASS] Reject set-defaults attempt as testuser2 (expected failure)
Exit code: 0

▶ Allow testuser2 to change their own password...
Command: env DB_ROOT_USER=testuser2 DB_ROOT_PASS=Test1234! python3 test/../cli/db137.py users passwd testuser2 --new-pass Changed567!
Password updated.
[PASS] Allow testuser2 to change their own password

▶ Verify login as testuser2 with new password...
Command: env DB_ROOT_USER=testuser2 DB_ROOT_PASS=Changed567! python3 test/../cli/db137.py users whoami
Connected as: testuser2@localhost
[PASS] Verify login as testuser2 with new password

▶ Drop all test users...
Command: python3 test/../cli/db137.py users drop-all
Skipping 'root' user.
Dropped user testuser2.
Dropped user testuser3.
[PASS] Drop all test users

▶ Final users list...
Command: python3 test/../cli/db137.py users list
- root
  GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE, CREATE ROLE, DROP ROLE ON *.* TO `root`@`%` WITH GRANT OPTION
  GRANT APPLICATION_PASSWORD_ADMIN,AUDIT_ABORT_EXEMPT,AUDIT_ADMIN,AUTHENTICATION_POLICY_ADMIN,BACKUP_ADMIN,BINLOG_ADMIN,BINLOG_ENCRYPTION_ADMIN,CLONE_ADMIN,CONNECTION_ADMIN,ENCRYPTION_KEY_ADMIN,FIREWALL_EXEMPT,FLUSH_OPTIMIZER_COSTS,FLUSH_STATUS,FLUSH_TABLES,FLUSH_USER_RESOURCES,GROUP_REPLICATION_ADMIN,GROUP_REPLICATION_STREAM,INNODB_REDO_LOG_ARCHIVE,INNODB_REDO_LOG_ENABLE,PASSWORDLESS_USER_ADMIN,PERSIST_RO_VARIABLES_ADMIN,REPLICATION_APPLIER,REPLICATION_SLAVE_ADMIN,RESOURCE_GROUP_ADMIN,RESOURCE_GROUP_USER,ROLE_ADMIN,SENSITIVE_VARIABLES_OBSERVER,SERVICE_CONNECTION_ADMIN,SESSION_VARIABLES_ADMIN,SET_USER_ID,SHOW_ROUTINE,SYSTEM_USER,SYSTEM_VARIABLES_ADMIN,TABLE_ENCRYPTION_ADMIN,TELEMETRY_LOG_ADMIN,XA_RECOVER_ADMIN ON *.* TO `root`@`%` WITH GRANT OPTION
[PASS] Final users list

========================================
Tests completed.
Total: 24  |  Passed: 24  |  Failed: 0

